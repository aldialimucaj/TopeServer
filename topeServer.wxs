<?xml version="1.0" encoding="utf-8"?>
<!--
    # This comment is generated by WixEdit, the specific commandline
    # arguments for the WiX Toolset are stored here.

    candleArgs: "<projectfile>" -out "<projectname>.wixobj" -ext WixUIExtension -ext WixUtilExtension -ext WixNetFxExtension
    lightArgs: "<projectname>.wixobj" -out "<projectname>.msi" -ext WixUIExtension -ext WixUtilExtension -ext WixNetFxExtension
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="611EFDF4-B339-49A0-AE1F-D1172B3878BA" Name="Tope Server" Language="1033" Version="0.0.2.2" Manufacturer="Aldi Alimucaj" UpgradeCode="DE8892D1-EE16-4A9C-8D1D-214CB77A0E73">
        <Package Description="TopeServer is a host for the Tope architecture." Manufacturer="Aldi Alimucaj" Comments="Tope Server" InstallerVersion="300" Compressed="yes" />
        <Media Id="1" Cabinet="simple.cab" EmbedCab="yes" />
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder" Name="PFiles">
                <!-- Auto-start via Registry -->
                <Component Id="AutoStartTope" Guid="0B226FD1-A57B-4CE6-A291-4642DDD2FB42">
                    <RegistryValue Id="TopeServer.rst" Root="HKMU" Action="write" Key="Software\Microsoft\Windows\CurrentVersion\Run" Name="TopeServer" Value="[RELEASE]TopeServer.exe" Type="string" />
                    <Condition>ASSISTANCE_START_VIA_REGISTRY</Condition>
                </Component>
                <Directory Id="RELEASE" Name="TopeServer">
                    <Component Id="WINDOWSINPUT.DLL" DiskId="1" Guid="5CEF530E-6A42-4D74-BA4B-FFDF66B511A8">
                        <File Id="WINDOWSINPUT.DLL" Name="WindowsInput.dll" Source="TopeServer\bin\Release\WindowsInput.dll" />
                    </Component>
                    <Component Id="NANCY.DLL" DiskId="1" Guid="2C37F25C-AE5B-447C-985C-B3FF414A9913">
                        <File Id="NANCY.DLL" Name="Nancy.dll" Source="TopeServer\bin\Release\Nancy.dll" />
                    </Component>
                    <Component Id="NANCY.HOSTING.SELF.DLL" DiskId="1" Guid="3696268D-788A-4328-8088-BD225BD63DA5">
                        <File Id="NANCY.HOSTING.SELF.DLL" Name="Nancy.Hosting.Self.dll" Source="TopeServer\bin\Release\Nancy.Hosting.Self.dll" />
                    </Component>
                    <Component Id="NEWTONSOFT.JSON.DLL" DiskId="1" Guid="D4946DB5-DA83-47BF-9215-2EB6E4955D4B">
                        <File Id="NEWTONSOFT.JSON.DLL" Name="Newtonsoft.Json.dll" Source="TopeServer\bin\Release\Newtonsoft.Json.dll" />
                    </Component>
                    <Component Id="NEWTONSOFT.JSON.XML" DiskId="1" Guid="1BEC5488-56D2-472B-9A21-59D4B2BEC8BC">
                        <File Id="NEWTONSOFT.JSON.XML" Name="Newtonsoft.Json.xml" Source="TopeServer\bin\Release\Newtonsoft.Json.xml" />
                    </Component>
                    <Component Id="BOUNCYCASTLE.CRYPTOEXT.DLL" DiskId="1" Guid="4B88D280-5D3B-4B63-A9E3-D2A8BB9758F9">
                        <File Id="BOUNCYCASTLE.CRYPTOEXT.DLL" Name="BouncyCastle.CryptoExt.dll" Source="TopeServer\bin\Release\BouncyCastle.CryptoExt.dll" />
                    </Component>
                    <Component Id="COREAUDIOAPI.DLL" DiskId="1" Guid="72DE49AF-F320-4906-A37D-954EDB823626">
                        <File Id="COREAUDIOAPI.DLL" Name="CoreAudioApi.dll" Source="TopeServer\bin\Release\CoreAudioApi.dll" />
                    </Component>
                    <Component Id="ENTITYFRAMEWORK.DLL" DiskId="1" Guid="E67040A2-91AB-4EC2-A5C3-1792552D5A34">
                        <File Id="ENTITYFRAMEWORK.DLL" Name="EntityFramework.dll" Source="TopeServer\bin\Release\EntityFramework.dll" />
                    </Component>
                    <Component Id="ENTITYFRAMEWORK.XML" DiskId="1" Guid="CB4EA9A0-6F4D-4485-B708-6F2D289BFC08">
                        <File Id="ENTITYFRAMEWORK.XML" Name="EntityFramework.xml" Source="TopeServer\bin\Release\EntityFramework.xml" />
                    </Component>
                    <Component Id="SYSTEM.DATA.SQLITE.DLL" DiskId="1" Guid="110D5EF6-27BA-409A-A091-BFE785A58F2F">
                        <File Id="SYSTEM.DATA.SQLITE.DLL" Name="System.Data.SQLite.dll" Source="TopeServer\bin\Release\System.Data.SQLite.dll" />
                    </Component>
                    <Component Id="SYSTEM.DATA.SQLITE.LINQ.DLL" DiskId="1" Guid="27416614-0B4A-4690-B7D7-B855AFC2AECF">
                        <File Id="SYSTEM.DATA.SQLITE.LINQ.DLL" Name="System.Data.SQLite.Linq.dll" Source="TopeServer\bin\Release\System.Data.SQLite.Linq.dll" />
                    </Component>
                    <Directory Id="x86Folder" Name="x86">
                        <Component Id="SQLITE.INTEROP.x86.DLL" Guid="988324E2-B424-46EA-8F17-CE2351CBB950">
                            <File Id="SQLITE.INTEROP.x86.DLL" Name="SQLite.Interop.dll" Source="TopeServer\bin\Release\x86\SQLite.Interop.dll" />
                        </Component>
                    </Directory>
                    <Directory Id="x64Folder" Name="x64">
                        <Component Id="SQLITE.INTEROP.x64.DLL" Guid="8A4DE94D-C114-4914-8E7F-241786855E6F">
                            <File Id="SQLITE.INTEROP.x64.DLL" Name="SQLite.Interop.dll" Source="TopeServer\bin\Release\x64\SQLite.Interop.dll" />
                        </Component>
                    </Directory>
                    <Component Id="TOPESERVER.INI" Guid="79E91FD5-11F9-4B44-BA06-F33527D3DAFD">
                        <File Id="TOPESERVER.INI" Name="TopeServer.ini" Source="TopeServer\bin\Release\TopeServer.ini" />
                    </Component>
                    <Component Id="TOPESERVER.EXE.CONFIG" Guid="06AB8C08-C427-4872-9D23-7EF5742A5D72">
                        <File Id="TOPESERVER.EXE.CONFIG" Name="TopeServer.exe.config" Source="TopeServer\bin\Release\TopeServer.exe.config" />
                    </Component>
                    <Component Id="TOPESERVER.EXE" DiskId="1" Guid="175581EC-D629-4AAC-AF47-F73AD1ED1D13">
                        <File Id="TOPESERVER.EXE" Name="TopeServer.exe" Source="TopeServer\bin\Release\TopeServer.exe">
                            <Shortcut Id="ExeShortcut" Directory="ProgramMenuDir" Name="TopeServer" Advertise="yes" Icon="StartMenuIcon.exe" IconIndex="0" />
                        </File>
                    </Component>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ProgramMenuDir" Name="Tope">
                    <Component Id="StartMenuShortcuts" Guid="64B7907D-72AC-43B1-A372-E1CE30F4540E">
                        <RemoveFolder Id="ProgramMenuDir" On="uninstall" />
                        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" Type="string" Value="" />
                        <Shortcut Id="UninstallProduct" Name="Uninstall Tope Server" Description="Uninstalls the TopeServer and removes its services." Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
                    </Component>
                </Directory>
            </Directory>
        </Directory>
        <Feature Id="DefaultFeature" Title="Main Feature" Level="1">
            <ComponentRef Id="WINDOWSINPUT.DLL" />
            <ComponentRef Id="NANCY.DLL" />
            <ComponentRef Id="NANCY.HOSTING.SELF.DLL" />
            <ComponentRef Id="NEWTONSOFT.JSON.DLL" />
            <ComponentRef Id="NEWTONSOFT.JSON.XML" />
            <ComponentRef Id="BOUNCYCASTLE.CRYPTOEXT.DLL" />
            <ComponentRef Id="COREAUDIOAPI.DLL" />
            <ComponentRef Id="ENTITYFRAMEWORK.DLL" />
            <ComponentRef Id="ENTITYFRAMEWORK.XML" />
            <ComponentRef Id="SYSTEM.DATA.SQLITE.DLL" />
            <ComponentRef Id="SYSTEM.DATA.SQLITE.LINQ.DLL" />
            <ComponentRef Id="SQLITE.INTEROP.x86.DLL" />
            <ComponentRef Id="SQLITE.INTEROP.x64.DLL" />
            <ComponentRef Id="TOPESERVER.INI" />
            <ComponentRef Id="TOPESERVER.EXE.CONFIG" />
            <ComponentRef Id="TOPESERVER.EXE" />
            <ComponentRef Id="StartMenuShortcuts" />
            <ComponentRef Id="AutoStartTope" />
        </Feature>
        <UI>
            <UIRef Id="WixUI_Minimal" />
            <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
        </UI>
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch Tope Server" />
        <PropertyRef Id="NETFRAMEWORK40FULL" />
        <Condition Message="This application requires .NET Framework 4.0.">Installed OR NETFRAMEWORK40FULL</Condition>
        <Icon Id="StartMenuIcon.exe" SourceFile="TopeServer\bin\Release\TopeServer.exe" />
        <Property Id="ASSISTANCE_START_VIA_REGISTRY">1</Property>
        <Property Id="WixShellExecTarget" Value="[RELEASE]TopeServer.exe" />
		<CustomAction Id="CreateScheduledTask" 
			Return="check"
			Directory="RELEASE"
			ExeCommand="&quot;[SystemFolder]SCHTASKS.EXE&quot; /CREATE /F /SC onlogon /TN &quot;Tope Task&quot; /RL highest /TR &quot;[RELEASE]TopeServer.exe&quot; /RU [%USERDOMAIN]\[LogonUser]" 
			Impersonate="no"
			Execute="deferred"
			/>
		<CustomAction Id="DeleteUpdateTask" 
			Return="asyncNoWait"
			Directory="RELEASE"
			ExeCommand="&quot;[SystemFolder]SCHTASKS.EXE&quot; /Delete /F /TN &quot;Tope Task&quot;" 
			Impersonate="no"
			Execute="deferred"
			/>
        <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />
		<InstallExecuteSequence>
         <Custom Action="CreateScheduledTask" After="InstallFiles">NOT Installed</Custom>
		 <Custom Action="DeleteUpdateTask" Before="RemoveFiles">Installed</Custom>
      </InstallExecuteSequence>
	  <MajorUpgrade
		Schedule="afterInstallValidate"
		DowngradeErrorMessage="A later version of Tope Server is already installed. Setup will now exit."
		/>
    </Product>
	
</Wix>